<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nexo Custom Interior — 施工标准</title>
  <meta name="description" content="Nexo Custom Interior 施工标准图文库，支持手机临时标注（刷新后清除），并可调整描述位置与字体大小。" />
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1222; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --brand:#ff6b35;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans SC","PingFang SC",Arial,sans-serif;background:radial-gradient(1200px 800px at 70% -10%, #1f2937 0%, var(--bg) 60%);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
    a{color:#ffd3c3}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(15,23,42,.75));backdrop-filter: blur(6px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:38px;height:38px;border-radius:12px;display:grid;place-items:center;background:conic-gradient(from 180deg,#ffedd5,#fecaca,#fde68a,#ffedd5);color:#111;font-weight:900}
    .brand h1{font-size:1.1rem;margin:0}
    .nav{margin-left:auto;display:flex;gap:10px}
    .nav a{background:#1e293b;color:#e5e7eb;text-decoration:none;padding:8px 12px;border-radius:8px}

    .panel{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px}
    .grid{display:grid;grid-template-columns:280px 1fr;gap:16px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}

    .sidebar{display:flex;flex-direction:column;gap:12px}
    .sidebar h3{margin:0 0 6px}
    .cats{display:grid;gap:8px}
    .cats button{background:#1e293b;color:#e5e7eb;border:1px solid rgba(255,255,255,.08);padding:10px 12px;text-align:left;border-radius:10px;cursor:pointer}
    .cats button.active{outline:2px solid rgba(255,107,53,.35);background:#243244}

    .viewer{display:flex;flex-direction:column;gap:10px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .toolbar .btn{background:#fff;color:#111;font-weight:700;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    .toolbar .btn.ghost{background:transparent;color:#e5e7eb;border:1px dashed rgba(255,255,255,.25)}
    .toolbar label{display:flex;align-items:center;gap:6px;background:#0b1222;border:1px solid rgba(255,255,255,.15);padding:8px 10px;border-radius:8px}
    .toolbar select,.toolbar input[type="range"]{accent-color:#ff6b35}

    .stage{position:relative;background:#0b1222;border:1px solid rgba(255,255,255,.1);border-radius:12px;overflow:hidden;min-height:300px;isolation:isolate}
    .stage img{display:block;max-width:100%;height:auto;margin:0 auto}
    canvas#sketch{position:absolute;inset:0;touch-action:none;z-index:2}
    .photo-tag{position:absolute;left:12px;bottom:12px;z-index:3;pointer-events:none;max-width:72%;
      font-size:1.1rem;line-height:1.35;font-weight:800;color:#fff;
      background:rgba(15,23,42,.45);
      padding:10px 12px;border-radius:10px;
      backdrop-filter: blur(3px);
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      text-shadow: 0 1px 2px rgba(0,0,0,.35)}

    .desc{background:#0b1222;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px;color:#cbd5e1;min-height:50px}
    .photo-desc{margin-top:6px;font-size:.9rem;color:#facc15}
    footer{margin-top:auto}
    footer .wrap{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;color:#94a3b8}
      /* 动态对比度样式：深色底/浅色字 与 浅色底/深色字 */
    .photo-tag.dark{ color:#fff; background:rgba(15,23,42,.45); text-shadow: 0 1px 2px rgba(0,0,0,.35); }
    .photo-tag.light{ color:#111; background:rgba(255,255,255,.55); text-shadow: none; }
      /* 定位类（更稳妥） */
    .photo-tag.pos-lt{left:12px;top:12px;right:auto;bottom:auto}
    .photo-tag.pos-lb{left:12px;bottom:12px;right:auto;top:auto}
    .photo-tag.pos-rt{right:12px;top:12px;left:auto;bottom:auto}
    .photo-tag.pos-rb{right:12px;bottom:12px;left:auto;top:auto}
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <div class="logo">NX</div>
      <h1>Nexo Custom Interior — 施工标准</h1>
      <nav class="nav">
        <a href="index.html">返回工作日志</a>
      </nav>
    </div>
  </header>

  <main class="wrap" style="padding:18px 18px 28px">
    <div class="grid">
      <!-- Sidebar: categories and image pickers -->
      <aside class="sidebar panel">
        <h3>类目</h3>
        <div class="cats" id="catList"></div>
        <div class="panel" style="margin-top:8px">
          <strong>当前图片</strong>
          <div id="imageList" style="margin-top:8px;display:grid;gap:6px"></div>
        </div>
        <div class="panel" style="margin-top:8px">
          <strong>如何上传照片？</strong>
          <ol style="margin:8px 0 0 18px;color:#cbd5e1">
            <li>把图片放到 <code>/assets/standards/类目名/</code> 目录（如 <code>assets/standards/踢脚线标准/</code>）。</li>
            <li>在下面的 <code>DATA</code> 配置里添加文件名与描述（示例已给）。</li>
            <li>保存并刷新本页面即可看到新图片。</li>
          </ol>
        </div>
      </aside>

      <!-- Viewer -->
      <section class="viewer">
        <div class="toolbar">
          <button class="btn" id="prevBtn">上一张</button>
          <button class="btn" id="nextBtn">下一张</button>
          <button class="btn ghost" id="clearDraw">清除临时标注</button>
          <label>笔粗细<input id="size" type="range" min="2" max="20" value="6"></label>
          <label>笔颜色<input id="color" type="color" value="#ff6b35"></label>
          <label>描述位置<select id="tagPos">
            <option value=\"lb\">左下</option>
            <option value=\"lt\" selected>左上</option>
            <option value="rb">右下</option>
            <option value="rt">右上</option>
          </select></label>
          <label>描述字体<input id="tagSize" type="range" min="0.9" max="1.6" step="0.05" value="1.1"></label>
        </div>
        <div class="stage" id="stage">
          <img id="photo" alt="标准示例" src=""/>
          <canvas id="sketch"></canvas>
          <div class="photo-tag dark" id="photoTag"></div>
        </div>
        <div class="desc" id="desc">选择左侧类目与图片进行查看。可在图片上临时绘画，刷新后自动清空。
          <div class="photo-desc" id="photoDesc"></div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="wrap">
      <small>© <span id="year"></span> Nexo Custom Interior</small>
      <small style="opacity:.8">临时标注不会保存；刷新即清除。</small>
    </div>
  </footer>

  <script>
    // ======== DATA（替换为你的真实文件名和描述；保持目录结构） ========
    // 每个类目对应一个图片列表和描述；文件放在 /assets/standards/{类目}/ 目录下
    const DATA = {
      "踢脚线标准": [
        {file:"baseboard_01.jpg", desc:"踢脚线安装平直，无明显缝隙"},
        {file:"baseboard_02.jpg", desc:"转角处拼接紧密，打胶顺滑"}
      ],
      "门框标准": [
        {file:"doorframe_01.jpg", desc:"门框垂直度良好，表面无破损"}
      ],
      "打胶标准": [
        {file:"caulk_01.jpg", desc:"胶线均匀，边缘整齐"},
        {file:"caulk_02.jpg", desc:"转角处饱满无断点"}
      ],
      "补洞标准": [
        {file:"patch_01.jpg", desc:"补洞平整，与周围墙面颜色一致"}
      ],
      "平整标准": [
        {file:"flatness_01.jpg", desc:"墙面平整，手感光滑无起伏"}
      ]
    };
    const BASE = "assets/standards/"; // 根目录

    // ======== DOM refs ========
    const catList = document.getElementById('catList');
    const imageList = document.getElementById('imageList');
    const img = document.getElementById('photo');
    const desc = document.getElementById('desc');
    const photoDesc = document.getElementById('photoDesc');
    const photoTag = document.getElementById('photoTag');
    const stage = document.getElementById('stage');
    const canvas = document.getElementById('sketch');
    const ctx = canvas.getContext('2d');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const clearBtn = document.getElementById('clearDraw');
    const size = document.getElementById('size');
    const color = document.getElementById('color');
    const tagPos = document.getElementById('tagPos');
    const tagSize = document.getElementById('tagSize');

    let currentCat = Object.keys(DATA)[0] || null;
    let currentIndex = 0;

    // ======== Init ========
    document.getElementById('year').textContent = new Date().getFullYear();
    buildCats();
    if(currentCat){ loadCat(currentCat); }
    window.addEventListener('resize', fitCanvas);

    function buildCats(){
      catList.innerHTML = '';
      Object.keys(DATA).forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat;
        btn.className = 'cat';
        btn.addEventListener('click', ()=> loadCat(cat));
        catList.appendChild(btn);
      });
    }

    function loadCat(cat){
      currentCat = cat; currentIndex = 0;
      [...catList.children].forEach(b=> b.classList.toggle('active', b.textContent===cat));
      renderImageList();
      showImage();
    }

    function renderImageList(){
      imageList.innerHTML = '';
      (DATA[currentCat]||[]).forEach((item, i)=>{
        const a = document.createElement('a');
        a.href = '#'; a.textContent = item.file; a.style.textDecoration='none'; a.style.color='#cbd5e1';
        a.addEventListener('click', (e)=>{ e.preventDefault(); currentIndex = i; showImage(); });
        imageList.appendChild(a);
      });
    }

    function showImage(){
      const item = (DATA[currentCat]||[])[currentIndex];
      if(!item){ img.removeAttribute('src'); photoDesc.textContent = ''; photoTag.textContent=''; return; }
      const src = `${BASE}${currentCat}/${item.file}`;
      img.src = src;
      photoDesc.textContent = item.desc || '';
      photoTag.textContent = item.desc || '';
      // 首屏即应用定位与对比
      if (typeof applyTagStyle === 'function') { applyTagStyle(); }
      if (typeof applyTagContrast === 'function') {
        requestAnimationFrame(()=>applyTagContrast());
      }
      }
      // 清空画布
      ctx.clearRect(0,0,canvas.width, canvas.height);
      // 等待图片尺寸就绪后适配画布
      img.onload = ()=>{ fitCanvas(); applyTagContrast(); };
    }

    function fitCanvas(){
      const rect = stage.getBoundingClientRect();
      canvas.width = rect.width; canvas.height = rect.height;
      ctx.clearRect(0,0,canvas.width, canvas.height);
    }

    // ======== Drawing（临时） ========
    let drawing = false; let last = null;
    function startDraw(x,y){ drawing = true; last = {x,y}; }
    function moveDraw(x,y){
      if(!drawing) return;
      ctx.lineCap = 'round'; ctx.lineJoin = 'round';
      ctx.strokeStyle = color.value; ctx.lineWidth = +size.value;
      ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(x,y); ctx.stroke();
      last = {x,y};
    }
    function endDraw(){ drawing = false; last = null; }

    // Mouse
    canvas.addEventListener('mousedown', e=> startDraw(e.offsetX, e.offsetY));
    canvas.addEventListener('mousemove', e=> moveDraw(e.offsetX, e.offsetY));
    window.addEventListener('mouseup', endDraw);

    // Touch
    canvas.addEventListener('touchstart', e=>{
      const t = e.changedTouches[0];
      const r = canvas.getBoundingClientRect();
      startDraw(t.clientX - r.left, t.clientY - r.top);
      e.preventDefault();
    }, {passive:false});
    canvas.addEventListener('touchmove', e=>{
      const t = e.changedTouches[0]; const r = canvas.getBoundingClientRect();
      moveDraw(t.clientX - r.left, t.clientY - r.top);
      e.preventDefault();
    }, {passive:false});
    canvas.addEventListener('touchend', endDraw);

    // 工具：清除、上下张
    clearBtn.addEventListener('click', ()=> ctx.clearRect(0,0,canvas.width, canvas.height));
    prevBtn.addEventListener('click', ()=>{ currentIndex = (currentIndex - 1 + DATA[currentCat].length) % DATA[currentCat].length; showImage(); });
    nextBtn.addEventListener('click', ()=>{ currentIndex = (currentIndex + 1) % DATA[currentCat].length; showImage(); });

    // 描述块：位置与字体
    function applyTagStyle(){
      const pos = tagPos.value;
      // 先清空内联定位，避免与类冲突
      photoTag.style.left = photoTag.style.right = photoTag.style.top = photoTag.style.bottom = '';
      // 切换定位类
      photoTag.classList.remove('pos-lt','pos-lb','pos-rt','pos-rb');
      const map = { lt:'pos-lt', lb:'pos-lb', rt:'pos-rt', rb:'pos-rb' };
      photoTag.classList.add(map[pos] || 'pos-lt');
      // 字体大小
      photoTag.style.fontSize = tagSize.value + 'rem';
      // 确保可见
      photoTag.style.visibility = 'visible';
    }
      if(pos==='lt'){ photoTag.style.left=gap; photoTag.style.top=gap; }
      if(pos==='rb'){ photoTag.style.right=gap; photoTag.style.bottom=gap; }
      if(pos==='rt'){ photoTag.style.right=gap; photoTag.style.top=gap; }
      photoTag.style.fontSize = tagSize.value + 'rem';
      // 确保显示
      photoTag.style.display = 'block';
    }
      if(pos==='lt'){ photoTag.style.left=gap; photoTag.style.top=gap; }
      if(pos==='rb'){ photoTag.style.right=gap; photoTag.style.bottom=gap; }
      if(pos==='rt'){ photoTag.style.right=gap; photoTag.style.top=gap; }
      photoTag.style.fontSize = tagSize.value + 'rem';
    }
    tagPos.addEventListener('change', applyTagStyle);
    tagSize.addEventListener('input', applyTagStyle);
    applyTagStyle();
    // —— 根据图片整体色调，自动选择描述的对比色 ——
    function analyzeToneFromImage(image){
      try{
        const off = document.createElement('canvas');
        const w = 64, h = 64;
        off.width = w; off.height = h;
        const c2 = off.getContext('2d');
        c2.drawImage(image, 0, 0, w, h);
        const data = c2.getImageData(0,0,w,h).data;
        let sum = 0; // 平均亮度
        for(let i=0;i<data.length;i+=4){
          const r = data[i], g = data[i+1], b = data[i+2];
          // Rec. 709 加权亮度
          sum += 0.2126*r + 0.7152*g + 0.0722*b;
        }
        return sum / (w*h);
      }catch(e){
        return 128; // 出错时给中性值
      }
    }
    function applyTagContrast(){
      const lum = analyzeToneFromImage(img);
      const isBright = lum >= 170; // 阈值可微调 160-180
      photoTag.classList.remove('light','dark');
      photoTag.classList.add(isBright ? 'light' : 'dark');
    }
  </script>
</body>
</html>
